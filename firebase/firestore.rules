rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is member
    function isMember() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'member';
    }
    
    // Helper function to check if accessing own data
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Users collection - stores user profiles and roles
    match /users/{userId} {
      // Anyone authenticated can read their own user document
      allow read: if isOwner(userId) || isAdmin();
      // Only admins can create/update/delete users
      allow create, update, delete: if isAdmin();
    }
    
    // Members collection - detailed member profiles
    match /members/{memberId} {
      // Members can read their own profile, admins can read all
      allow read: if isOwner(memberId) || isAdmin();
      // Only admins can write
      allow create, update, delete: if isAdmin();
    }
    
    // Sessions collection - training sessions
    match /sessions/{sessionId} {
      // All authenticated users can read sessions
      allow read: if request.auth != null;
      // Only admins can create/update/delete sessions
      allow create, update, delete: if isAdmin();
    }
    
    // Attendance collection - session RSVPs
    match /attendance/{attendanceId} {
      // Users can read their own attendance, admins can read all
      allow read: if isOwner(resource.data.userId) || isAdmin();
      // Members can create/update their own attendance
      allow create: if isMember() && request.auth.uid == request.resource.data.userId;
      allow update: if (isMember() && isOwner(resource.data.userId)) || isAdmin();
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Invoices collection - payment records
    match /invoices/{invoiceId} {
      // Users can read their own invoices, admins can read all
      allow read: if isOwner(resource.data.memberId) || isAdmin();
      // Only admins can create invoices
      allow create: if isAdmin();
      // Members can update status to "Transfer Initiated", admins can update anything
      allow update: if (isMember() && 
                       isOwner(resource.data.memberId) && 
                       request.resource.data.status == 'Transfer Initiated' &&
                       resource.data.status == 'Pending') || 
                      isAdmin();
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Personal Bests collection
    match /personalBests/{pbId} {
      // Users can read their own PBs, admins can read all
      allow read: if isOwner(resource.data.memberId) || isAdmin();
      // Only admins can write PBs
      allow create, update, delete: if isAdmin();
    }
  }
}
