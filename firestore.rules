rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin users collection - allow reading own document, admins/editors can read all
    match /adminUsers/{userId} {
      allow read: if request.auth.uid == userId || 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role in ['admin', 'editor'];
      // Allow creating own document (for new users) OR if creator is admin
      allow create: if request.auth != null && (
        request.auth.uid == userId || 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role == 'admin'
      );
      allow update: if request.auth.uid == userId || 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role == 'admin';
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Partners collection - admins and editors can write, everyone can read
    match /partners/{partnerId} {
      allow read: if true;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role in ['admin', 'editor'];
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Guest Instructors collection - admins and editors can write, everyone can read
    match /guestInstructors/{instructorId} {
      allow read: if true;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role in ['admin', 'editor'];
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role == 'admin';
    }

    // Blog posts collection - published posts readable by everyone, authenticated users can read all for admin
    match /blog_posts/{postId} {
      // Helper function to check if user has a role
      function getUserRole() {
        return get(/databases/$(database)/documents/adminUsers/$(request.auth.uid)).data.role;
      }
      
      function isAdmin() {
        return request.auth != null && getUserRole() == 'admin';
      }
      
      function isEditor() {
        return request.auth != null && getUserRole() == 'editor';
      }
      
      // Read rules: Check simple conditions first to avoid unnecessary get() calls
      // 1. Published posts - anyone can read
      // 2. Own posts - authors can read their own (check before role lookup)
      // 3. Admins/editors can read all (requires role lookup)
      allow read: if resource.data.status == 'published' || 
        (request.auth != null && resource.data.author == request.auth.uid) ||
        isAdmin() ||
        isEditor();
      
      // Create rule: Check author match first before role lookup
      allow create: if request.auth != null && (
        (request.resource.data.status == 'draft' && request.resource.data.author == request.auth.uid) ||
        (getUserRole() in ['admin', 'editor'])
      );
      
      // Update rules: Check simple conditions first
      // 1. Anyone can update view count
      // 2. Admins can update everything
      // 3. Editors can update everything
      // 4. Authors can update only their own drafts or submit for review
      allow update: if (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views'])) ||
        (request.auth != null && getUserRole() == 'admin') ||
        (request.auth != null && getUserRole() == 'editor') ||
        (request.auth != null && 
         resource.data.author == request.auth.uid &&
         request.resource.data.author == request.auth.uid &&
         request.resource.data.status in ['draft', 'review'] &&
         resource.data.status == 'draft');
      
      allow delete: if request.auth != null && getUserRole() == 'admin';
    }
  }
}
